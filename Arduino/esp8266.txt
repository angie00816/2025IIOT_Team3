/*
 * ESP8266 WiFi 橋接器（含重連與 RAW 顯示）
 */
#include <ESP8266WiFi.h>
#include <ESP8266HTTPClient.h>
#include <ArduinoJson.h>

// ============ WiFi 設定 ============
const char* ssid = "iPhone (7)";
const char* password = "00000000";

// ============ 後端伺服器設定 ============
const char* serverURL = "http://172.20.10.3:5000/api/data";

// ============ 狀態變數 ============
unsigned long lastWiFiCheck = 0;
unsigned long lastStatusPrint = 0;
bool wifiConnected = false;

// ============ 初始化 ============
void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("\n=== ESP8266 WiFi 橋接器啟動 ===");
  Serial.println("等待 Arduino 資料...");
  connectToWiFi();
}

// ============ WiFi 連接函數 ============
void connectToWiFi() {
  Serial.println("\n--- WiFi 連接中 ---");
  Serial.print("SSID: ");
  Serial.println(ssid);

  WiFi.mode(WIFI_STA);
  WiFi.disconnect();
  delay(100);
  WiFi.begin(ssid, password);

  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
    if (attempts % 5 == 0) {
      Serial.print(" [嘗試 ");
      Serial.print(attempts);
      Serial.print("/30, 狀態: ");
      Serial.print(WiFi.status());
      Serial.println("]");
    }
  }
  Serial.println();
  if (WiFi.status() == WL_CONNECTED) {
    wifiConnected = true;
    Serial.println("✓ WiFi 連接成功！");
    Serial.print("IP 位址: ");
    Serial.println(WiFi.localIP());
    Serial.print("訊號強度: ");
    Serial.print(WiFi.RSSI());
    Serial.println(" dBm");
    Serial.print("後端伺服器: ");
    Serial.println(serverURL);
    Serial.println("系統就緒，等待 Arduino 資料...\n");
  } else {
    wifiConnected = false;
    Serial.println("✗ WiFi 連接失敗！");
    Serial.print("狀態碼: ");
    Serial.println(WiFi.status());
    Serial.println("將在 5 秒後重試...\n");
  }
}

// ============ 主迴圈 ============
void loop() {
  // 每 5 秒檢查 WiFi
  if (millis() - lastWiFiCheck > 5000) {
    lastWiFiCheck = millis();
    if (WiFi.status() != WL_CONNECTED) {
      if (wifiConnected) {
        Serial.println("\n[警告] WiFi 已斷線！");
        wifiConnected = false;
      }
      Serial.println("[重連] 嘗試重新連接 WiFi...");
      connectToWiFi();
    } else if (!wifiConnected) {
      Serial.println("\n[重連] WiFi 重新連接成功！");
      wifiConnected = true;
      Serial.print("IP 位址: ");
      Serial.println(WiFi.localIP());
      Serial.print("訊號強度: ");
      Serial.print(WiFi.RSSI());
      Serial.println(" dBm\n");
    }
  }

  // 每 30 秒狀態顯示
  if (millis() - lastStatusPrint > 30000) {
    lastStatusPrint = millis();
    if (WiFi.status() == WL_CONNECTED) {
      Serial.print("[狀態檢查] WiFi 已連接，IP: ");
      Serial.print(WiFi.localIP());
      Serial.print("，RSSI: ");
      Serial.print(WiFi.RSSI());
      Serial.println(" dBm");
    } else {
      Serial.println("[狀態檢查] WiFi 未連接");
    }
  }

  // 接收 Arduino 的 JSON
  if (Serial.available()) {
    String jsonString = Serial.readStringUntil('\n');
    jsonString.trim();
    if (jsonString.length() > 0) {
      Serial.print("[RAW] ");
      Serial.println(jsonString);  // 直接顯示收到的 JSON

      // 驗證 JSON
      StaticJsonDocument<512> doc;
      DeserializationError error = deserializeJson(doc, jsonString);
      if (error) {
        Serial.print("JSON 解析錯誤: ");
        Serial.println(error.c_str());
        return;
      }

      // WiFi 連上才送
      if (WiFi.status() == WL_CONNECTED) {
        sendToServer(jsonString);
      } else {
        Serial.println("✗ WiFi 未連接，無法發送資料");
        Serial.println("等待 WiFi 重新連接...\n");
      }
    }
  }

  delay(100);
}

// ============ 發送資料到後端伺服器 ============
void sendToServer(String jsonData) {
  HTTPClient http;
  WiFiClient client;
  http.begin(client, serverURL);
  http.addHeader("Content-Type", "application/json");
  Serial.println("發送資料到伺服器...");
  int httpResponseCode = http.POST(jsonData);
  if (httpResponseCode > 0) {
    Serial.print("HTTP 回應碼: ");
    Serial.println(httpResponseCode);
    String response = http.getString();
    if (response.length() > 0) {
      Serial.print("伺服器回應: ");
      Serial.println(response);
    }
  } else {
    Serial.print("HTTP 錯誤: ");
    Serial.println(httpResponseCode);
    Serial.print("錯誤訊息: ");
    Serial.println(http.errorToString(httpResponseCode));
  }
  http.end();
  Serial.println("---\n");
}